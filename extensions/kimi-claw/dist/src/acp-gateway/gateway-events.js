import{randomUUID}from"node:crypto";import{isPlainRecord as isRecord}from"../utils/json.js";import{MessageQueue}from"../utils/mq.js";import{asNonEmptyTextChunk as asTextChunk,asTrimmedNonEmptyString as asString,normalizeTransportText}from"../utils/text.js";import{resolveUriFileName}from"./prompt-converter.js";import{buildToolResultSessionContentBlocks}from"../tool-result-message-blocks.js";import{resolveToolResultPayloadFromStrategies}from"./tool-result-payload-strategies.js";const MAIN_SESSION_KEY="agent:main:main",CRON_SIGNAL_WINDOW_MS=6e4,CRON_ASSISTANT_FLUSH_TIMEOUT_MS=12e4,CURRENT_ASSISTANT_STREAM_STALE_TIMEOUT_MS=6e5;export class AcpGatewayEvents{state;logger;sendSessionUpdate;completePrompt;failPrompt;replayMissingPromptArtifactsFromLocalHistory;cronRunIds=new Set;cronRequestIdsByKey=new Map;cronAssistantTsByKey=new Map;cronAssistantTextByKey=new Map;cronAssistantPayloadByKey=new Map;cronAssistantFlushTimersByKey=new Map;cronAssistantFlushTimeoutMs;lastMainCronSignalAtMs=0;currentAssistantStream=null;currentAssistantStreamOwnerId=null;activeLifecycleOwnerIds=new Set;currentAssistantStreamLastActiveAtMs=0;currentAssistantStreamStaleTimer;getCurrentAssistantStream(){return this.currentAssistantStream}isCurrentAssistantRunActive(){const t=this.currentAssistantStreamOwnerId;return!!t&&this.activeLifecycleOwnerIds.has(t)}resetCurrentAssistantStream(t){this.logger.warn(`[acp] force reset current assistant stream reason=${t} ownerId=${this.currentAssistantStreamOwnerId??"n/a"}`),this.closeCurrentAssistantStream()}constructor(t){this.state=t.state,this.logger=t.logger,this.sendSessionUpdate=t.sendSessionUpdate,this.completePrompt=t.completePrompt,this.failPrompt=t.failPrompt,this.replayMissingPromptArtifactsFromLocalHistory=t.replayMissingPromptArtifactsFromLocalHistory,this.cronAssistantFlushTimeoutMs="number"==typeof t.cronAssistantFlushTimeoutMs&&Number.isFinite(t.cronAssistantFlushTimeoutMs)&&t.cronAssistantFlushTimeoutMs>0?t.cronAssistantFlushTimeoutMs:12e4}handleGatewayResponse(t){const e=this.state.promptsByGatewayRequestId.get(t.id);if(e&&!e.done){if(!t.ok){const s=isRecord(t.error)&&asString(t.error.message)?asString(t.error.message):"gateway returned error";return void this.failPrompt(e,-32020,s??"gateway returned error",t.error)}if(isRecord(t.payload)){const s=asString(t.payload.runId);s?(this.state.bindPromptRunToRunId(e,s),this.logger.debug?.(`[acp] gateway.response bound runId=${s} requestId=${String(e.gatewayRequestId)} sessionId=${e.sessionId}`)):this.logger.debug?.(`[acp] gateway.response no runId in payload requestId=${String(e.gatewayRequestId)} sessionId=${e.sessionId}`)}}}handleGatewayCronEvent(t){if(!isRecord(t))return;const e=isRecord(t.payload)?t.payload:t,s=this.resolveSessionKey(e)??this.resolveSessionKey(t);if(s&&s!==MAIN_SESSION_KEY)return;this.lastMainCronSignalAtMs=Date.now();const n=asString(e.runId)??asString(e.run_id)??asString(t.runId)??asString(t.run_id);n&&this.cronRunIds.add(n)}async handleGatewayAgentEvent(t){if(!isRecord(t))return;const e=asString(t.stream),s=isRecord(t.data)?t.data:{},n=asString(t.runId)??asString(t.run_id),a=asString(t.requestId)??asString(t.request_id),r=n??a,i=asString(s.name)??asString(s.toolName)??asString(s.tool_name)??"tool",o=asString(s.toolCallId)??asString(s.tool_call_id)??asString(s.callId)??asString(s.id),l=this.state.resolvePromptRun(t);if(!l||l.done)return this.logger.debug?.(`[acp][uncorrelated-agent] stream=${e||"unknown"} runId=${n||"n/a"} requestId=${a||"n/a"} tool=${i} toolCallId=${o||"n/a"}`),void this.handleUncorrelatedMainCronAssistantEvent(t);this.logger.debug?.(`[acp][agent-event] stream=${e||"unknown"} runId=${n||"n/a"} requestId=${a||"n/a"} tool=${i} toolCallId=${o||"n/a"} sessionId=${l.sessionId}`);const c={before:{type:"event",event:"agent",payload:t},hop:"openclaw_gateway->plugin",where:"AcpGatewayBridge.handleGatewayAgentEvent"},d=this.resolvePayloadTimestamp(t),u=this.withTimestamp(l.rpcId,d),h=t=>{if(this.sendSessionUpdate(l.sessionId,t,u,c),this.currentAssistantStream){const e={data:t};void 0!==d&&(e.ts=d),this.currentAssistantStream.push(e),this.touchCurrentAssistantStreamActivity()}},g=()=>{h({sessionUpdate:"agent_message_chunk",content:{type:"text",text:"\n"}})};if("assistant"===e){l.hasAgentAssistantStream=!0;const t=asTextChunk(s.delta)??asTextChunk(s.text);t&&h({sessionUpdate:"agent_message_chunk",content:{type:"text",text:t}});const e=[];Array.isArray(s.content)?e.push(...s.content):isRecord(s.content)?e.push(s.content):"string"==typeof s.type&&e.push(s);for(const s of e){if(!isRecord(s))continue;const e=asString(s.type);if("thinking"===e){l.hasAgentThinkingStream=!0;const t=this.normalizeText(s.thinking)??this.normalizeText(s.text);if(!t)continue;h({sessionUpdate:"agent_thought_chunk",content:{type:"text",text:t}});continue}if("toolCall"===e){g(),l.hasAgentToolStartStream=!0;const t=this.resolveToolCallId(l,s,"start"),e=asString(s.name)??asString(s.toolName)??asString(s.tool_name)??"tool",n=isRecord(s.arguments)?s.arguments:isRecord(s.args)?s.args:{};h({sessionUpdate:"tool_call",toolCallId:t,title:e,status:"in_progress",content:[{type:"content",content:{type:"text",text:JSON.stringify(n,null,2)}}]});continue}if("toolResult"===e){g(),l.hasAgentToolResultStream=!0;const t=this.resolveToolCallId(l,s,"result"),e=asString(s.name)??asString(s.toolName)??asString(s.tool_name)??"tool",n=buildToolResultSessionContentBlocks(e,s);if(n.length>0){h({sessionUpdate:"tool_call_update",toolCallId:t,title:e,status:"completed",content:n});continue}const a=this.normalizeText(s.text)??this.normalizeText(s.result)??(isRecord(s.result)||Array.isArray(s.result)?JSON.stringify(s.result,null,2):void 0);if(!a)continue;h({sessionUpdate:"tool_call_update",toolCallId:t,title:e,status:"completed",content:[{type:"content",content:{type:"text",text:a}}]});continue}const n=this.toSessionMessageContentBlock(s);n&&("text"===asString(n.type)&&t||h({sessionUpdate:"agent_message_chunk",content:n}))}return}if("thinking"===e){l.hasAgentThinkingStream=!0;const t=asTextChunk(s.delta)??asTextChunk(s.text);return void(t&&h({sessionUpdate:"agent_thought_chunk",content:{type:"text",text:t}}))}if("tool"===e){const t=asString(s.phase),e=this.resolveToolCallId(l,s,t),r=asString(s.name)||asString(s.toolName)||asString(s.tool_name)||"tool",i=Object.keys(s).sort().join(",");if("start"===t){const t=isRecord(s.arguments)?s.arguments:isRecord(s.args)?s.args:{};this.logger.debug?.(`[acp][tool][start] runId=${n||"n/a"} requestId=${a||"n/a"} tool=${r} toolCallId=${e} sessionId=${l.sessionId} payloadKeys=${i} hasArgs=${isRecord(t)}`),g(),l.hasAgentToolStartStream=!0,h({sessionUpdate:"tool_call",toolCallId:e,title:r,status:"in_progress",content:[{type:"content",content:{type:"text",text:JSON.stringify(t,null,2)}}]})}else if("result"===t){const t=await resolveToolResultPayloadFromStrategies(r,s,{toolCallId:e}),o=t.delivery??"tool_call_update";this.logger.debug?.(`[acp][tool][result-resolved] runId=${n||"n/a"} requestId=${a||"n/a"} tool=${r} toolCallId=${e} source=${t.source} payloadKeys=${i} sessionId=${l.sessionId}`);const c=t.payload??s,d=s;if("agent_message_chunk"===o){const t=buildToolResultSessionContentBlocks(r,c);if(t.length>0){g(),l.hasAgentToolResultStream=!0;let s=!1;for(const e of t){if(!isRecord(e))continue;const t=isRecord(e.content)?e.content:void 0,n=t?this.toSessionMessageContentBlock(t):void 0;n&&(s=!0,h({sessionUpdate:"agent_message_chunk",content:n}))}s&&this.logger.debug?.(`[acp][tool][result-extra-dispatched] runId=${n||"n/a"} requestId=${a||"n/a"} tool=${r} toolCallId=${e} blockCount=${t.length} sessionId=${l.sessionId}`)}else this.logger.debug?.(`[acp][tool][result-empty-no-extra-message] runId=${n||"n/a"} requestId=${a||"n/a"} tool=${r} toolCallId=${e} sessionId=${l.sessionId}`)}const u=d.result??d.output??d,m=void 0!==d.result||void 0!==d.output,p=void 0!==d.details,y=void 0!==d.content,S=Array.isArray(u)?"array":null===u?"null":typeof u,f=isRecord(u)?Object.keys(u).sort().join(","):"";this.logger.debug?.(`[acp][tool][result-received] runId=${n||"n/a"} requestId=${a||"n/a"} tool=${r} toolCallId=${e} sessionId=${l.sessionId} payloadKeys=${i} resultShape=${S} hasResultOrOutput=${m} hasDetails=${p} hasContent=${y} recordKeys=${f}`),g(),l.hasAgentToolResultStream=!0;const I=buildToolResultSessionContentBlocks(r,d);if(I.length>0)return this.logger.debug?.(`[acp][tool][result-dispatched] runId=${n||"n/a"} requestId=${a||"n/a"} tool=${r} toolCallId=${e} blockCount=${I.length} sessionId=${l.sessionId}`),void h({sessionUpdate:"tool_call_update",toolCallId:e,status:"completed",content:I});const A=this.normalizeText(u)??(isRecord(u)||Array.isArray(u)?JSON.stringify(u,null,2):void 0);if("string"!=typeof A)return void this.logger.debug?.(`[acp][tool][result-drop-no-text] runId=${n||"n/a"} requestId=${a||"n/a"} tool=${r} toolCallId=${e} payloadHasResult=${!!d.result} payloadHasOutput=${!!d.output} payloadHasDetails=${!!d.details} payloadHasContent=${!!d.content} payloadKeys=${i} sessionId=${l.sessionId}`);this.logger.debug?.(`[acp][tool][result-text] runId=${n||"n/a"} requestId=${a||"n/a"} tool=${r} toolCallId=${e} textLen=${A.length} sessionId=${l.sessionId}`),h({sessionUpdate:"tool_call_update",toolCallId:e,status:"completed",content:[{type:"content",content:{type:"text",text:A}}]})}else this.logger.debug?.(`[acp][tool][phase-unknown] runId=${n||"n/a"} requestId=${a||"n/a"} tool=${r} toolCallId=${e} phase=${t||"n/a"} payloadKeys=${i} sessionId=${l.sessionId}`);return}if("lifecycle"===e){const e=asString(s.phase);if("start"===e?(this.closeCurrentAssistantStream(),r&&this.activeLifecycleOwnerIds.add(r),this.currentAssistantStream=new MessageQueue,this.currentAssistantStreamOwnerId=r??null,this.touchCurrentAssistantStreamActivity()):("end"!==e&&"cancelled"!==e&&"cancel"!==e&&"error"!==e||r&&this.activeLifecycleOwnerIds.delete(r),this.closeCurrentAssistantStream()),"end"===e)this.clearCronStreamTracking(t),this.replayMissingPromptArtifactsFromLocalHistory(l),this.completePrompt(l,"end_turn");else if("cancelled"===e||"cancel"===e)this.clearCronStreamTracking(t),this.completePrompt(l,"cancelled");else if("error"===e){this.clearCronStreamTracking(t);const e=isRecord(s.error)&&asString(s.error.message)?asString(s.error.message):void 0,n=asString(s.message)??e??"gateway lifecycle error";this.failPrompt(l,-32021,n,s)}}}handleGatewayChatEvent(t){if(!isRecord(t))return;const e=this.state.resolvePromptRun(t);if(!e||e.done)return void this.handleUncorrelatedMainCronChatEvent(t);const s={before:{type:"event",event:"chat",payload:t},hop:"openclaw_gateway->plugin",where:"AcpGatewayBridge.handleGatewayChatEvent"},n=this.resolvePayloadTimestamp(t),a=this.withTimestamp(e.rpcId,n),r=()=>{this.maybeCompletePromptFromChatState(e,t)},i=isRecord(t.message)?t.message:void 0;if(!i)return void r();const o=asString(i.role);if(o){if("assistant"===o){const n=[];Array.isArray(i.content)?n.push(...i.content):"string"==typeof i.content?n.push({type:"text",text:i.content}):isRecord(i.content)&&n.push(i.content);for(const r of n){if(!isRecord(r))continue;const n=asString(r.type);if(!n)continue;if("thinking"===n){if(e.hasAgentThinkingStream)continue;const t=this.normalizeText(r.thinking)??this.normalizeText(r.text);if(!t)continue;const n=`chat:thinking:${t}`;if(e.chatReplayDedupKeys.has(n))continue;e.chatReplayDedupKeys.add(n),this.sendSessionUpdate(e.sessionId,{sessionUpdate:"agent_thought_chunk",content:{type:"text",text:t}},a,s);continue}if("toolCall"===n){if(this.sendToolCallSpacer(e.sessionId,a,{before:{type:"event",event:"chat",payload:t},hop:"openclaw_gateway->plugin",where:"AcpGatewayBridge.handleGatewayChatEvent"}),e.hasAgentToolStartStream)continue;const n=this.resolveToolCallId(e,r,"start"),i=asString(r.name)??asString(r.toolName)??asString(r.tool_name)??"tool",o=isRecord(r.arguments)?r.arguments:isRecord(r.args)?r.args:{},l=`chat:tool_start:${n}:${JSON.stringify(o)}`;if(e.chatReplayDedupKeys.has(l))continue;e.chatReplayDedupKeys.add(l),this.sendSessionUpdate(e.sessionId,{sessionUpdate:"tool_call",toolCallId:n,title:i,status:"in_progress",content:[{type:"content",content:{type:"text",text:JSON.stringify(o,null,2)}}]},a,s);continue}if("toolResult"===n){if(this.sendToolCallSpacer(e.sessionId,a,{before:{type:"event",event:"chat",payload:t},hop:"openclaw_gateway->plugin",where:"AcpGatewayBridge.handleGatewayChatEvent"}),e.hasAgentToolResultStream)continue;const n=this.resolveToolCallId(e,r,"result"),i=asString(r.name)??asString(r.toolName)??asString(r.tool_name)??"tool",o=buildToolResultSessionContentBlocks(i,r);if(o.length>0){const t=`chat:tool_result:${n}:${JSON.stringify(o)}`;if(e.chatReplayDedupKeys.has(t))continue;e.chatReplayDedupKeys.add(t),this.sendSessionUpdate(e.sessionId,{sessionUpdate:"tool_call_update",toolCallId:n,title:i,status:"completed",content:o},a,s);continue}const l=this.normalizeText(r.text)??this.normalizeText(r.result)??(isRecord(r.result)||Array.isArray(r.result)?JSON.stringify(r.result,null,2):void 0);if(!l)continue;const c=`chat:tool_result:${n}:${l}`;if(e.chatReplayDedupKeys.has(c))continue;e.chatReplayDedupKeys.add(c),this.sendSessionUpdate(e.sessionId,{sessionUpdate:"tool_call_update",toolCallId:n,title:i,status:"completed",content:[{type:"content",content:{type:"text",text:l}}]},a,s);continue}const i=this.toSessionMessageContentBlock(r);if(!i)continue;if("text"===asString(i.type)){if(e.hasAgentAssistantStream)continue;const t=asString(i.text),n=this.toChatAssistantDeltaText(e,t);if(!n)continue;this.sendSessionUpdate(e.sessionId,{sessionUpdate:"agent_message_chunk",content:{type:"text",text:n}},a,s);continue}const o=`chat:assistant_chunk:${JSON.stringify(i)}`;e.chatReplayDedupKeys.has(o)||(e.chatReplayDedupKeys.add(o),this.sendSessionUpdate(e.sessionId,{sessionUpdate:"agent_message_chunk",content:i},a,s))}return void r()}if("toolResult"===o){if(e.hasAgentToolResultStream)return void r();const t=asString(i.toolCallId)??asString(i.tool_call_id);if(!t)return void r();const n=asString(i.toolName)??asString(i.tool_name)??"tool",o=this.extractMessageText({content:i.content});if(!o)return void r();const l=`chat:tool_result:${t}:${o}`;if(e.chatReplayDedupKeys.has(l))return void r();e.chatReplayDedupKeys.add(l),this.sendSessionUpdate(e.sessionId,{sessionUpdate:"tool_call_update",toolCallId:t,title:n,status:"completed",content:[{type:"content",content:{type:"text",text:o}}]},a,s)}r()}else r()}maybeCompletePromptFromChatState(t,e){if(t.done||"chat.send"!==t.gatewayMethod)return;const s=asString(e.state)?.toLowerCase();if(s)if("final"!==s)if("aborted"!==s&&"cancelled"!==s&&"cancel"!==s){if("error"===s){const s=isRecord(e.error)?e.error:void 0,n=asString(e.summary)??asString(e.message)??asString(s?.message)??"gateway chat error";this.failPrompt(t,-32021,n,e)}}else this.completePrompt(t,"cancelled");else this.completePrompt(t,"end_turn")}handleUncorrelatedMainCronChatEvent(t){if(this.resolveSessionKey(t)!==MAIN_SESSION_KEY)return;if(!this.isCronAssistantCandidate(t))return;const e=isRecord(t.message)?t.message:void 0;if(!e)return;if("user"!==asString(e.role))return;const s="user_message_chunk",n={before:{type:"event",event:"chat",payload:t},hop:"openclaw_gateway->plugin",where:"AcpGatewayBridge.handleGatewayChatEvent.cron"},a=this.resolveCronSessionUpdateMeta(t),r=e.content,i=[];Array.isArray(r)?i.push(...r):isRecord(r)&&i.push(r);let o=!1;for(const t of i){if(!isRecord(t))continue;const e=this.toSessionMessageContentBlock(t);e&&(this.sendSessionUpdate(MAIN_SESSION_KEY,{sessionUpdate:s,content:e},a,n),o=!0)}if(o)return;const l=this.extractMessageText({content:r});l&&this.sendSessionUpdate(MAIN_SESSION_KEY,{sessionUpdate:s,content:{type:"text",text:l}},a,n)}handleUncorrelatedMainCronAssistantEvent(t){const e=asString(t.stream);if("lifecycle"===e){const e=isRecord(t.data)?t.data:{},s=asString(e.phase),n=asString(t.runId)??asString(t.run_id)??asString(t.requestId)??asString(t.request_id);return"start"===s&&n&&this.activeLifecycleOwnerIds.add(n),"end"!==s&&"cancelled"!==s&&"cancel"!==s&&"error"!==s||(n&&this.activeLifecycleOwnerIds.delete(n),this.maybeCloseCurrentAssistantStreamForUncorrelatedLifecycle(t)),void("end"===s?(this.flushCronAssistantText(t),this.clearCronStreamTracking(t)):"cancelled"!==s&&"cancel"!==s&&"error"!==s||this.clearCronStreamTracking(t))}if("assistant"!==e)return void(e&&this.logger.debug?.(`[acp][uncorrelated-agent] stream=${e} runId=${asString(t.runId)||asString(t.run_id)||"n/a"} requestId=${asString(t.requestId)||asString(t.request_id)||"n/a"} sessionKey=${this.resolveSessionKey(t)||"n/a"}`));if(this.resolveSessionKey(t)!==MAIN_SESSION_KEY)return;if(!this.isCronAssistantCandidate(t))return;const s={before:{type:"event",event:"agent",payload:t},hop:"openclaw_gateway->plugin",where:"AcpGatewayBridge.handleGatewayAgentEvent.cron"},n=this.resolveCronSessionUpdateMeta(t),a=isRecord(t.data)?t.data:{},r=asTextChunk(a.delta)??asTextChunk(a.text);r&&this.bufferCronAssistantText(t,r,n,s);const i=[];Array.isArray(a.content)?i.push(...a.content):isRecord(a.content)?i.push(a.content):"string"==typeof a.type&&i.push(a);for(const e of i){if(!isRecord(e))continue;const a=asString(e.type);if("thinking"===a||"toolCall"===a||"toolResult"===a)continue;const i=this.toSessionMessageContentBlock(e);if(i){if("text"===asString(i.type)){if(r)continue;const e=asString(i.text);e&&this.bufferCronAssistantText(t,e,n,s);continue}this.sendSessionUpdate(MAIN_SESSION_KEY,{sessionUpdate:"agent_message_chunk",content:i},n,s)}}}sendToolCallSpacer(t,e,s){this.sendSessionUpdate(t,{sessionUpdate:"agent_message_chunk",content:{type:"text",text:"\n"}},e,s)}isCronAssistantCandidate(t){const e=asString(t.runId)??asString(t.run_id);return!(!e||!this.cronRunIds.has(e))||!(Date.now()-this.lastMainCronSignalAtMs>6e4)&&(e&&this.cronRunIds.add(e),!0)}resolveSessionKey(t){const e=asString(t.sessionKey)??asString(t.session_key);if(e)return e;const s=isRecord(t.payload)?t.payload:void 0;if(s){const t=asString(s.sessionKey)??asString(s.session_key);if(t)return t}const n=isRecord(t.data)?t.data:void 0;if(n){const t=asString(n.sessionKey)??asString(n.session_key);if(t)return t}}resolveCronSessionUpdateMeta(t){const e=this.resolveCronStreamKey(t),s=this.resolveCronSessionUpdateMetaByKey(e),n=this.resolvePayloadTimestamp(t);return void 0===n?s:(e&&this.cronAssistantTsByKey.set(e,n),void 0!==s.timestamp?s:{...s,timestamp:n})}resolveCronSessionUpdateMetaByKey(t){if(!t)return{requestId:randomUUID(),messageType:"cron"};const e=this.cronRequestIdsByKey.get(t);if(e){const s=this.cronAssistantTsByKey.get(t);return void 0===s?{requestId:e,messageType:"cron"}:{requestId:e,messageType:"cron",timestamp:s}}const s=randomUUID();this.cronRequestIdsByKey.set(t,s);const n=this.cronAssistantTsByKey.get(t);return void 0===n?{requestId:s,messageType:"cron"}:{requestId:s,messageType:"cron",timestamp:n}}resolveCronStreamKey(t){const e=asString(t.runId)??asString(t.run_id);if(e)return`run:${e}`;const s=asString(t.requestId)??asString(t.request_id);return s?`request:${s}`:void 0}clearCronStreamTracking(t){const e=asString(t.runId)??asString(t.run_id);e&&this.clearCronStreamTrackingByKey(`run:${e}`);const s=asString(t.requestId)??asString(t.request_id);s&&this.clearCronStreamTrackingByKey(`request:${s}`)}clearCronStreamTrackingByKey(t){this.cronRequestIdsByKey.delete(t),this.cronAssistantTsByKey.delete(t),this.cronAssistantTextByKey.delete(t),this.cronAssistantPayloadByKey.delete(t);const e=this.cronAssistantFlushTimersByKey.get(t);if(e&&(clearTimeout(e),this.cronAssistantFlushTimersByKey.delete(t)),t.startsWith("run:")){const e=t.slice(4);e&&this.cronRunIds.delete(e)}}bufferCronAssistantText(t,e,s,n){const a=this.normalizeText(e);if(!a)return;const r=this.resolveCronStreamKey(t);if(!r)return void this.sendSessionUpdate(MAIN_SESSION_KEY,{sessionUpdate:"agent_message_chunk",content:{type:"text",text:a}},s,n);const i=this.cronAssistantTextByKey.get(r)??"";this.cronAssistantTextByKey.set(r,`${i}${a}`),this.cronAssistantPayloadByKey.set(r,t),this.scheduleCronAssistantFlush(r)}flushCronAssistantText(t){const e=this.resolveCronStreamKey(t);e&&this.flushCronAssistantTextByKey(e,"end",t)}scheduleCronAssistantFlush(t){const e=this.cronAssistantFlushTimersByKey.get(t);e&&clearTimeout(e);const s=setTimeout(()=>{this.cronAssistantFlushTimersByKey.delete(t),this.flushCronAssistantTextByKey(t,"timeout")},this.cronAssistantFlushTimeoutMs);this.cronAssistantFlushTimersByKey.set(t,s)}flushCronAssistantTextByKey(t,e,s){const n=this.cronAssistantFlushTimersByKey.get(t);n&&(clearTimeout(n),this.cronAssistantFlushTimersByKey.delete(t));const a=this.cronAssistantTextByKey.get(t);if(!a)return void("timeout"===e&&this.clearCronStreamTrackingByKey(t));this.cronAssistantTextByKey.delete(t);const r=s??this.cronAssistantPayloadByKey.get(t);this.cronAssistantPayloadByKey.delete(t);const i=this.normalizeText(a);if(!i)return void("timeout"===e&&this.clearCronStreamTrackingByKey(t));const o=this.resolveCronSessionUpdateMetaByKey(t),l="timeout"===e?"timeout":"end";this.sendSessionUpdate(MAIN_SESSION_KEY,{sessionUpdate:"agent_message_chunk",content:{type:"text",text:i}},o,{before:r?{type:"event",event:"agent",payload:r}:{type:"event",event:"cron",payload:{key:t,reason:e}},hop:"openclaw_gateway->plugin",where:`AcpGatewayBridge.handleGatewayAgentEvent.cron.flush.${l}`}),"timeout"===e&&this.clearCronStreamTrackingByKey(t)}extractMessageText(t){const e=t.content;if("string"==typeof e)return this.normalizeText(e);if(Array.isArray(e)){const t=[];for(const s of e)if(isRecord(s)){const e=this.normalizeText(s.text);e&&t.push(e)}if(!t.length)return;return this.normalizeText(t.join("\n"))}}resolvePayloadTimestamp(t){const e=this.resolveTimestampValue(t.ts);if(void 0!==e)return e;const s=this.resolveTimestampValue(t.timestamp);if(void 0!==s)return s;const n=isRecord(t.payload)?t.payload:void 0;if(n){const t=this.resolvePayloadTimestamp(n);if(void 0!==t)return t}const a=isRecord(t.data)?t.data:void 0;if(a){const t=this.resolvePayloadTimestamp(a);if(void 0!==t)return t}const r=isRecord(t.message)?t.message:void 0;if(r){const t=this.resolvePayloadTimestamp(r);if(void 0!==t)return t}}closeCurrentAssistantStream(){this.currentAssistantStreamStaleTimer&&(clearTimeout(this.currentAssistantStreamStaleTimer),this.currentAssistantStreamStaleTimer=void 0),this.currentAssistantStreamLastActiveAtMs=0,this.currentAssistantStreamOwnerId&&this.activeLifecycleOwnerIds.delete(this.currentAssistantStreamOwnerId),this.currentAssistantStream?.close(),this.currentAssistantStream=null,this.currentAssistantStreamOwnerId=null}touchCurrentAssistantStreamActivity(){this.currentAssistantStream&&(this.currentAssistantStreamLastActiveAtMs=Date.now(),this.scheduleCurrentAssistantStreamStaleClose())}scheduleCurrentAssistantStreamStaleClose(){this.currentAssistantStreamStaleTimer&&(clearTimeout(this.currentAssistantStreamStaleTimer),this.currentAssistantStreamStaleTimer=void 0),this.currentAssistantStream&&(this.currentAssistantStreamStaleTimer=setTimeout(()=>{if(this.currentAssistantStreamStaleTimer=void 0,!this.currentAssistantStream)return;const t=Date.now()-this.currentAssistantStreamLastActiveAtMs;t<6e5?this.scheduleCurrentAssistantStreamStaleClose():this.resetCurrentAssistantStream(`stale stream auto-close idleMs=${t} thresholdMs=600000`)},6e5))}maybeCloseCurrentAssistantStreamForUncorrelatedLifecycle(t){if(!this.currentAssistantStream)return;const e=asString(t.runId)??asString(t.run_id)??asString(t.requestId)??asString(t.request_id);e&&this.currentAssistantStreamOwnerId&&e!==this.currentAssistantStreamOwnerId||this.closeCurrentAssistantStream()}withTimestamp(t,e){return void 0===e?t:"string"==typeof t||"number"==typeof t?{requestId:t,messageType:"normal",timestamp:e}:void 0!==t.timestamp?t:{...t,timestamp:e}}resolveTimestampValue(t){if("number"==typeof t&&Number.isFinite(t))return t;if("string"==typeof t){const e=Date.parse(t);if(Number.isFinite(e))return e}}normalizeText(t){return normalizeTransportText(t)}toChatAssistantDeltaText(t,e){const s=this.normalizeText(e);if(!s)return;const n=t.chatAssistantTextSoFar;if(!n)return t.chatAssistantTextSoFar=s,s;if(s!==n){if(s.startsWith(n)){const e=s.slice(n.length);return t.chatAssistantTextSoFar=s,e||void 0}if(!n.startsWith(s))return t.chatAssistantTextSoFar=s,s}}toSessionMessageContentBlock(t){const e=asString(t.type);if(e){if("text"===e){const e=this.normalizeText(t.text);if(!e)return;return{type:"text",text:e}}if("image"===e){const e=asString(t.data),s=asString(t.uri);if(!e&&!s)return;const n=asString(t.mimeType)??asString(t.mime_type),a=asString(t.fileName)??asString(t.file_name)??asString(t.filename)??asString(t.name)??(s?resolveUriFileName(s):void 0);return{type:"image",...e?{data:e}:{},...s?{uri:s}:{},...n?{mimeType:n}:{},...a?{fileName:a}:{}}}if("resource_link"===e){const e=asString(t.uri);if(!e)return;const s=asString(t.title),n=asString(t.name),a=asString(t.mimeType)??asString(t.mime_type);return{type:"resource_link",uri:e,...s?{title:s}:{},...n?{name:n}:{},...a?{mimeType:a}:{}}}if("resource"===e){const e=isRecord(t.resource)?t.resource:{},s=asString(e.uri)??asString(t.uri),n=asString(e.mimeType)??asString(e.mime_type)??asString(t.mimeType)??asString(t.mime_type),a=this.normalizeText(e.text)??this.normalizeText(t.text),r=asString(e.data)??asString(t.data),i=asString(e.fileName)??asString(e.file_name)??asString(e.filename)??asString(e.name)??asString(t.fileName)??asString(t.file_name)??asString(t.filename)??asString(t.name)??(s?resolveUriFileName(s):void 0);if(!s&&!a&&!r)return;return{type:"resource",resource:{...s?{uri:s}:{},...n?{mimeType:n}:{},...a?{text:a}:{},...r?{data:r}:{},...i?{fileName:i}:{}}}}if("file"===e){const e=asString(t.data),s=this.normalizeText(t.text),n=asString(t.uri),a=asString(t.mimeType)??asString(t.mime_type),r=asString(t.fileName)??asString(t.file_name)??asString(t.filename)??asString(t.name)??(n?resolveUriFileName(n):void 0);if(!e&&!s&&!n)return;return{type:"file",...e?{data:e}:{},...s?{text:s}:{},...n?{uri:n}:{},...a?{mimeType:a}:{},...r?{fileName:r}:{}}}}}resolveToolCallId(t,e,s){const n=asString(e.toolCallId)||asString(e.tool_call_id)||asString(e.callId)||asString(e.id);if(n){return t.toolCallIdsByIncomingId.get(n)||(t.toolCallIdsByIncomingId.set(n,n),n)}if("result"===s){const e=t.pendingGeneratedToolCallIds.shift();if(e)return e}t.nextGeneratedToolCallId+=1;const a=`tc_${t.gatewayRequestId}_${t.nextGeneratedToolCallId}`;return"start"===s&&t.pendingGeneratedToolCallIds.push(a),a}}